"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var context = {
  api: {},
  service: {},
  dao: {}
}; // 动态加载文件

function dynamicRequrie(path) {
  var map = {};

  if (_fs.default.existsSync(path)) {
    var childs = _fs.default.readdirSync(path);

    childs.forEach(childName => {
      var info = _fs.default.statSync(path + "/" + childName);

      if (!info.isDirectory()) {
        var result = /(\S+)\.(js|ts)$/.exec(childName);

        if (result && result[1] !== 'index') {
          map[result[1]] = require(path + '/' + childName);
        }
      }
    });
  }

  return map;
}

function inject(constructor, instance) {
  if (constructor.inject) {
    constructor.inject.forEach(injectName => {
      Object.defineProperty(instance, injectName, {
        get() {
          return context.dao[injectName] || context.service[injectName] || context.api[injectName];
        }

      });
    });
  }
}

function registerDao(app) {
  var daoMap = dynamicRequrie(_path.default.resolve(__dirname, './dao'));
  Object.keys(daoMap).forEach(daoName => {
    context.dao[daoName] = new daoMap[daoName]();
  });
}

function registerService(app) {
  var serviceMap = dynamicRequrie(_path.default.resolve(__dirname, './service'));
  Object.keys(serviceMap).forEach(serviceName => {
    var ServiceConstructor = serviceMap[serviceName];
    context.service[serviceName] = new ServiceConstructor();
    inject(ServiceConstructor, context.service[serviceName]);
  });
}

function registerApiRouter(app) {
  var apiMap = dynamicRequrie(_path.default.resolve(__dirname, './api'));
  Object.keys(apiMap).map(apiName => {
    var ApiConstructor = apiMap[apiName];
    var apiInstance = new ApiConstructor();
    inject(ApiConstructor, apiInstance);
    Object.getOwnPropertyNames(ApiConstructor.prototype).map(key => {
      if (apiInstance[key].requestMethod) {
        var {
          requestUrl,
          requestMethod,
          middleWare
        } = apiInstance[key];
        middleWare = middleWare || [];
        middleWare.push(apiInstance[key]);
        var middleWares = [];
        middleWare.forEach(fn => {
          middleWares.push((req, res, next) => {
            fn.call(apiInstance, req, res, next);
          });
        });
        app[requestMethod](requestUrl, ...middleWares);
      }
    });
  });
}

function registerStaticFileRouter(app) {
  app.use(app.get('express').static(_path.default.resolve(__dirname, '../static')));
  app.use('/card', app.get('express').static(_path.default.resolve(__dirname, '../cards')));
}

var Context = {
  init: app => {
    app.context = context;
    registerService(app);
    registerApiRouter(app);
    registerDao(app);
    registerStaticFileRouter(app);
  }
};

class AppContext {
  constructor() {
    this.controller = {};
    this.service = {};
    this.dao = {};
  }

  dynamicRequrie(path) {
    var map = {};

    if (_fs.default.existsSync(path)) {
      var childs = _fs.default.readdirSync(path);

      childs.forEach(childName => {
        var info = _fs.default.statSync(path + "/" + childName);

        if (!info.isDirectory()) {
          var result = /(\S+)\.(js|ts)$/.exec(childName);

          if (result && result[1] !== 'index') {
            map[result[1]] = require(path + '/' + childName);
          }
        }
      });
    }

    return map;
  }

}

var _default = Context;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb250ZXh0LnRzIl0sIm5hbWVzIjpbImNvbnRleHQiLCJhcGkiLCJzZXJ2aWNlIiwiZGFvIiwiZHluYW1pY1JlcXVyaWUiLCJwYXRoIiwibWFwIiwiZnMiLCJleGlzdHNTeW5jIiwiY2hpbGRzIiwicmVhZGRpclN5bmMiLCJmb3JFYWNoIiwiY2hpbGROYW1lIiwiaW5mbyIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJyZXN1bHQiLCJleGVjIiwicmVxdWlyZSIsImluamVjdCIsImNvbnN0cnVjdG9yIiwiaW5zdGFuY2UiLCJpbmplY3ROYW1lIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJnZXQiLCJyZWdpc3RlckRhbyIsImFwcCIsImRhb01hcCIsInJlc29sdmUiLCJfX2Rpcm5hbWUiLCJrZXlzIiwiZGFvTmFtZSIsInJlZ2lzdGVyU2VydmljZSIsInNlcnZpY2VNYXAiLCJzZXJ2aWNlTmFtZSIsIlNlcnZpY2VDb25zdHJ1Y3RvciIsInJlZ2lzdGVyQXBpUm91dGVyIiwiYXBpTWFwIiwiYXBpTmFtZSIsIkFwaUNvbnN0cnVjdG9yIiwiYXBpSW5zdGFuY2UiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwicHJvdG90eXBlIiwia2V5IiwicmVxdWVzdE1ldGhvZCIsInJlcXVlc3RVcmwiLCJtaWRkbGVXYXJlIiwicHVzaCIsIm1pZGRsZVdhcmVzIiwiZm4iLCJyZXEiLCJyZXMiLCJuZXh0IiwiY2FsbCIsInJlZ2lzdGVyU3RhdGljRmlsZVJvdXRlciIsInVzZSIsInN0YXRpYyIsIkNvbnRleHQiLCJpbml0IiwiQXBwQ29udGV4dCIsImNvbnRyb2xsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQU9BLElBQU1BLE9BQVksR0FBRztBQUNwQkMsRUFBQUEsR0FBRyxFQUFFLEVBRGU7QUFFcEJDLEVBQUFBLE9BQU8sRUFBRSxFQUZXO0FBR3BCQyxFQUFBQSxHQUFHLEVBQUU7QUFIZSxDQUFyQixDLENBTUE7O0FBQ0EsU0FB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LEdBQUcsR0FBUCxHQUFhTyxTQUF6QixDQUFyQjs7QUFDQSxZQUFJLENBQUNDLElBQUksQ0FBQ0UsV0FBTCxFQUFMLEVBQXlCO0FBQ3hCLGNBQUlDLE1BQU0sR0FBRyxrQkFBa0JDLElBQWxCLENBQXVCTCxTQUF2QixDQUFiOztBQUNBLGNBQUlJLE1BQU0sSUFBSUEsTUFBTSxDQUFDLENBQUQsQ0FBTixLQUFjLE9BQTVCLEVBQXFDO0FBQ3BDVixZQUFBQSxHQUFHLENBQUNVLE1BQU0sQ0FBQyxDQUFELENBQVAsQ0FBSCxHQUFpQkUsT0FBTyxDQUFDYixJQUFJLEdBQUcsR0FBUCxHQUFhTyxTQUFkLENBQXhCO0FBQ0E7QUFDRDtBQUNELE9BUkQ7QUFTQTs7QUFDRCxXQUFPTixHQUFQO0FBQ0E7O0FBM0JlOztlQThCRm9ELE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnXHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnXHJcblxyXG50eXBlIGNvbnRleHRNYXAgPSB7XHJcblx0W2tleTogc3RyaW5nXTogT2JqZWN0XHJcbn1cclxuXHJcbmNvbnN0IGNvbnRleHQ6IGFueSA9IHtcclxuXHRhcGk6IHt9LFxyXG5cdHNlcnZpY2U6IHt9LFxyXG5cdGRhbzoge31cclxufVxyXG5cclxuLy8g5Yqo5oCB5Yqg6L295paH5Lu2XHJcbmZ1bmN0aW9uIGR5bmFtaWNSZXF1cmllKHBhdGg6IHN0cmluZykge1xyXG5cdGxldCBtYXA6IGNvbnRleHRNYXAgPSB7fVxyXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XHJcblx0XHRsZXQgY2hpbGRzID0gZnMucmVhZGRpclN5bmMocGF0aClcclxuXHRcdGNoaWxkcy5mb3JFYWNoKGNoaWxkTmFtZSA9PiB7XHJcblx0XHRcdGxldCBpbmZvID0gZnMuc3RhdFN5bmMocGF0aCArIFwiL1wiICsgY2hpbGROYW1lKVxyXG5cdFx0XHRpZiAoIWluZm8uaXNEaXJlY3RvcnkoKSkge1xyXG5cdFx0XHRcdGxldCByZXN1bHQgPSAvKFxcUyspXFwuKGpzfHRzKSQvLmV4ZWMoY2hpbGROYW1lKVxyXG5cdFx0XHRcdGlmIChyZXN1bHQgJiYgcmVzdWx0WzFdICE9PSAnaW5kZXgnKSB7XHJcblx0XHRcdFx0XHRtYXBbcmVzdWx0WzFdXSA9IHJlcXVpcmUocGF0aCArICcvJyArIGNoaWxkTmFtZSlcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdH0pXHJcblx0fVxyXG5cdHJldHVybiBtYXBcclxufVxyXG5cclxuZnVuY3Rpb24gaW5qZWN0KGNvbnN0cnVjdG9yOiBhbnksIGluc3RhbmNlOiBhbnkpIHtcclxuXHRpZiAoY29uc3RydWN0b3IuaW5qZWN0KSB7XHJcblx0XHRjb25zdHJ1Y3Rvci5pbmplY3QuZm9yRWFjaCgoaW5qZWN0TmFtZTogYW55KSA9PiB7XHJcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpbnN0YW5jZSwgaW5qZWN0TmFtZSwge1xyXG5cdFx0XHRcdGdldCgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBjb250ZXh0LmRhb1tpbmplY3ROYW1lXSB8fCBjb250ZXh0LnNlcnZpY2VbaW5qZWN0TmFtZV0gfHwgY29udGV4dC5hcGlbaW5qZWN0TmFtZV1cclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pXHJcblx0XHR9KVxyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaXN0ZXJEYW8oYXBwOiBBcHBsaWNhdGlvbikge1xyXG5cdGxldCBkYW9NYXA6IGFueSA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2RhbycpKVxyXG5cdE9iamVjdC5rZXlzKGRhb01hcCkuZm9yRWFjaChkYW9OYW1lID0+IHtcclxuXHRcdGNvbnRleHQuZGFvW2Rhb05hbWVdID0gbmV3IGRhb01hcFtkYW9OYW1lXSgpXHJcblx0fSlcclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaXN0ZXJTZXJ2aWNlKGFwcDogQXBwbGljYXRpb24pIHtcclxuXHRsZXQgc2VydmljZU1hcCA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL3NlcnZpY2UnKSlcclxuXHRPYmplY3Qua2V5cyhzZXJ2aWNlTWFwKS5mb3JFYWNoKHNlcnZpY2VOYW1lID0+IHtcclxuXHRcdGxldCBTZXJ2aWNlQ29uc3RydWN0b3I6IGFueSA9IHNlcnZpY2VNYXBbc2VydmljZU5hbWVdXHJcblx0XHRjb250ZXh0LnNlcnZpY2Vbc2VydmljZU5hbWVdID0gbmV3IFNlcnZpY2VDb25zdHJ1Y3RvcigpXHJcblx0XHRpbmplY3QoU2VydmljZUNvbnN0cnVjdG9yLCBjb250ZXh0LnNlcnZpY2Vbc2VydmljZU5hbWVdKVxyXG5cdH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlZ2lzdGVyQXBpUm91dGVyKGFwcDogYW55KSB7XHJcblx0bGV0IGFwaU1hcCA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2FwaScpKVxyXG5cdE9iamVjdC5rZXlzKGFwaU1hcCkubWFwKGFwaU5hbWUgPT4ge1xyXG5cdFx0bGV0IEFwaUNvbnN0cnVjdG9yOiBhbnkgPSBhcGlNYXBbYXBpTmFtZV1cclxuXHRcdGxldCBhcGlJbnN0YW5jZSA9IG5ldyBBcGlDb25zdHJ1Y3RvcigpXHJcblxyXG5cdFx0aW5qZWN0KEFwaUNvbnN0cnVjdG9yLCBhcGlJbnN0YW5jZSlcclxuXHJcblx0XHRPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhBcGlDb25zdHJ1Y3Rvci5wcm90b3R5cGUpLm1hcChrZXkgPT4ge1xyXG5cdFx0XHRpZiAoYXBpSW5zdGFuY2Vba2V5XS5yZXF1ZXN0TWV0aG9kKSB7XHJcblx0XHRcdFx0bGV0IHsgcmVxdWVzdFVybCwgcmVxdWVzdE1ldGhvZCwgbWlkZGxlV2FyZSB9ID0gYXBpSW5zdGFuY2Vba2V5XVxyXG5cdFx0XHRcdG1pZGRsZVdhcmUgPSBtaWRkbGVXYXJlIHx8IFtdXHJcblx0XHRcdFx0bWlkZGxlV2FyZS5wdXNoKGFwaUluc3RhbmNlW2tleV0pXHJcblx0XHRcdFx0bGV0IG1pZGRsZVdhcmVzOiBhbnkgPSBbXVxyXG5cdFx0XHRcdG1pZGRsZVdhcmUuZm9yRWFjaCgoZm46IEZ1bmN0aW9uKSA9PiB7XHJcblx0XHRcdFx0XHRtaWRkbGVXYXJlcy5wdXNoKChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IEZ1bmN0aW9uKSA9PiB7XHJcblx0XHRcdFx0XHRcdGZuLmNhbGwoYXBpSW5zdGFuY2UsIHJlcSwgcmVzLCBuZXh0KVxyXG5cdFx0XHRcdFx0fSlcclxuXHRcdFx0XHR9KVxyXG5cdFx0XHRcdGFwcFtyZXF1ZXN0TWV0aG9kXShyZXF1ZXN0VXJsLCAuLi5taWRkbGVXYXJlcylcclxuXHRcdFx0fVxyXG5cdFx0fSlcclxuXHR9KVxyXG59XHJcblxyXG5mdW5jdGlvbiByZWdpc3RlclN0YXRpY0ZpbGVSb3V0ZXIoYXBwOiBhbnkpIHtcclxuXHRhcHAudXNlKGFwcC5nZXQoJ2V4cHJlc3MnKS5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL3N0YXRpYycpKSlcclxuXHRhcHAudXNlKCcvY2FyZCcsIGFwcC5nZXQoJ2V4cHJlc3MnKS5zdGF0aWMocGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uL2NhcmRzJykpKVxyXG59XHJcblxyXG50eXBlIENvbnRleHQgPSB7XHJcblx0aW5pdChhcHA6IGFueSk6IHZvaWRcclxufVxyXG5cclxubGV0IENvbnRleHQ6IENvbnRleHQgPSB7XHJcblx0aW5pdDogKGFwcDogYW55KSA9PiB7XHJcblx0XHRhcHAuY29udGV4dCA9IGNvbnRleHRcclxuXHRcdHJlZ2lzdGVyU2VydmljZShhcHApXHJcblx0XHRyZWdpc3RlckFwaVJvdXRlcihhcHApXHJcblx0XHRyZWdpc3RlckRhbyhhcHApXHJcblx0XHRyZWdpc3RlclN0YXRpY0ZpbGVSb3V0ZXIoYXBwKVxyXG5cdH1cclxufVxyXG5cclxuY2xhc3MgQXBwQ29udGV4dCB7XHJcblx0cHJpdmF0ZSBjb250cm9sbGVyOiBjb250ZXh0TWFwXHJcblx0cHJpdmF0ZSBzZXJ2aWNlOiBjb250ZXh0TWFwXHJcblx0cHJpdmF0ZSBkYW86IGNvbnRleHRNYXBcclxuXHRwdWJsaWMgc3RhdGljIGluaXQ6IGFueVxyXG5cclxuXHRjb25zdHJ1Y3RvcigpIHtcclxuXHRcdHRoaXMuY29udHJvbGxlciA9IHt9XHJcblx0XHR0aGlzLnNlcnZpY2UgPSB7fVxyXG5cdFx0dGhpcy5kYW8gPSB7fVxyXG5cdH1cclxuXHJcblx0ZHluYW1pY1JlcXVyaWUocGF0aDogc3RyaW5nKSB7XHJcblx0XHRsZXQgbWFwOiBjb250ZXh0TWFwID0ge31cclxuXHRcdGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XHJcblx0XHRcdGxldCBjaGlsZHMgPSBmcy5yZWFkZGlyU3luYyhwYXRoKVxyXG5cdFx0XHRjaGlsZHMuZm9yRWFjaCgoY2hpbGROYW1lOiBzdHJpbmcpID0+IHtcclxuXHRcdFx0XHRsZXQgaW5mbzogZnMuU3RhdHMgPSBmcy5zdGF0U3luYyhwYXRoICsgXCIvXCIgKyBjaGlsZE5hbWUpXHJcblx0XHRcdFx0aWYgKCFpbmZvLmlzRGlyZWN0b3J5KCkpIHtcclxuXHRcdFx0XHRcdGxldCByZXN1bHQgPSAvKFxcUyspXFwuKGpzfHRzKSQvLmV4ZWMoY2hpbGROYW1lKVxyXG5cdFx0XHRcdFx0aWYgKHJlc3VsdCAmJiByZXN1bHRbMV0gIT09ICdpbmRleCcpIHtcclxuXHRcdFx0XHRcdFx0bWFwW3Jlc3VsdFsxXV0gPSByZXF1aXJlKHBhdGggKyAnLycgKyBjaGlsZE5hbWUpXHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KVxyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIG1hcFxyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgQ29udGV4dCJdfQ==