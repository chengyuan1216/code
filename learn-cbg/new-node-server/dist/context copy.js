"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("fs"));

var context = {
  api: {},
  service: {},
  dao: {}
}; // 动态加载文件

function dynamicRequrie(path) {
  var map = {};

  if (_fs.default.existsSync(path)) {
    var childs = _fs.default.readdirSync(path);

    childs.forEach(childName => {
      var info = _fs.default.statSync(path + "/" + childName);

      if (!info.isDirectory()) {
        var result = /(\S+)\.(js|ts)$/.exec(childName);

        if (result && result[1] !== 'index') {
          map[result[1]] = require(path + '/' + childName);
        }
      }
    });
  }

  return map;
}

function inject(constructor, instance) {
  if (constructor.inject) {
    constructor.inject.forEach(injectName => {
      Object.defineProperty(instance, injectName, {
        get() {
          return context.dao[injectName] || context.service[injectName] || context.api[injectName];
        }

      });
    });
  }
}

function registerDao(app) {
  var daoMap = dynamicRequrie(_path.default.resolve(__dirname, './dao'));
  Object.keys(daoMap).forEach(daoName => {
    context.dao[daoName] = new daoMap[daoName]();
  });
}

function registerService(app) {
  var serviceMap = dynamicRequrie(_path.default.resolve(__dirname, './service'));
  Object.keys(serviceMap).forEach(serviceName => {
    var ServiceConstructor = serviceMap[serviceName];
    context.service[serviceName] = new ServiceConstructor();
    inject(ServiceConstructor, context.service[serviceName]);
  });
}

function registerApiRouter(app) {
  var apiMap = dynamicRequrie(_path.default.resolve(__dirname, './api'));
  Object.keys(apiMap).map(apiName => {
    var ApiConstructor = apiMap[apiName].default;
    var apiInstance = new ApiConstructor();
    inject(ApiConstructor, apiInstance);
    Object.getOwnPropertyNames(ApiConstructor.prototype).map(key => {
      if (apiInstance[key].requestMethod) {
        var {
          requestUrl,
          requestMethod,
          middleWare
        } = apiInstance[key];
        middleWare = middleWare || [];
        middleWare.push(apiInstance[key]);
        var middleWares = [];
        middleWare.forEach(fn => {
          middleWares.push((req, res, next) => {
            fn.call(apiInstance, req, res, next);
          });
        });
        app[requestMethod](requestUrl, ...middleWares);
      }
    });
  });
}

function registerStaticFileRouter(app) {
  app.use(app.get('express').static(_path.default.resolve(__dirname, '../static')));
  app.use('/card', app.get('express').static(_path.default.resolve(__dirname, '../cards')));
}

var Context = {
  init: app => {
    app.context = context;
    registerService(app);
    registerApiRouter(app);
    registerDao(app);
    registerStaticFileRouter(app);
  }
};

class AppContext {
  constructor() {
    this.controller = {};
    this.service = {};
    this.dao = {};
  }

  dynamicRequrie(path) {
    var map = {};

    if (_fs.default.existsSync(path)) {
      var childs = _fs.default.readdirSync(path);

      childs.forEach(childName => {
        var info = _fs.default.statSync(path + "/" + childName);

        if (!info.isDirectory()) {
          var result = /(\S+)\.(js|ts)$/.exec(childName);

          if (result && result[1] !== 'index') {
            map[result[1]] = require(path + '/' + childName);
          }
        }
      });
    }

    return map;
  }

}

var _default = Context;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb250ZXh0IGNvcHkudHMiXSwibmFtZXMiOlsiY29udGV4dCIsImFwaSIsInNlcnZpY2UiLCJkYW8iLCJkeW5hbWljUmVxdXJpZSIsInBhdGgiLCJtYXAiLCJmcyIsImV4aXN0c1N5bmMiLCJjaGlsZHMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJjaGlsZE5hbWUiLCJpbmZvIiwic3RhdFN5bmMiLCJpc0RpcmVjdG9yeSIsInJlc3VsdCIsImV4ZWMiLCJyZXF1aXJlIiwiaW5qZWN0IiwiY29uc3RydWN0b3IiLCJpbnN0YW5jZSIsImluamVjdE5hbWUiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImdldCIsInJlZ2lzdGVyRGFvIiwiYXBwIiwiZGFvTWFwIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsImtleXMiLCJkYW9OYW1lIiwicmVnaXN0ZXJTZXJ2aWNlIiwic2VydmljZU1hcCIsInNlcnZpY2VOYW1lIiwiU2VydmljZUNvbnN0cnVjdG9yIiwicmVnaXN0ZXJBcGlSb3V0ZXIiLCJhcGlNYXAiLCJhcGlOYW1lIiwiQXBpQ29uc3RydWN0b3IiLCJkZWZhdWx0IiwiYXBpSW5zdGFuY2UiLCJnZXRPd25Qcm9wZXJ0eU5hbWVzIiwicHJvdG90eXBlIiwia2V5IiwicmVxdWVzdE1ldGhvZCIsInJlcXVlc3RVcmwiLCJtaWRkbGVXYXJlIiwicHVzaCIsIm1pZGRsZVdhcmVzIiwiZm4iLCJyZXEiLCJyZXMiLCJuZXh0IiwiY2FsbCIsInJlZ2lzdGVyU3RhdGljRmlsZVJvdXRlciIsInVzZSIsInN0YXRpYyIsIkNvbnRleHQiLCJpbml0IiwiQXBwQ29udGV4dCIsImNvbnRyb2xsZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQU9BLElBQU1BLE9BQVksR0FBRztBQUNwQkMsRUFBQUEsR0FBRyxFQUFFLEVBRGU7QUFFcEJDLEVBQUFBLE9BQU8sRUFBRSxFQUZXO0FBR3BCQyxFQUFBQSxHQUFHLEVBQUU7QUFIZSxDQUFyQixD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R0FBR04sWUFBR08sUUFBSCxDQUFZVCxJQUFJLEdBQUcsR0FBUCxHQUFhTyxTQUF6QixDQUFyQjs7QUFDQSxZQUFJLENBQUNDLElBQUksQ0FBQ0UsV0FBTCxFQUFMLEVBQXlCO0FBQ3hCLGNBQUlDLE1BQU0sR0FBRyxrQkFBa0JDLElBQWxCLENBQXVCTCxTQUF2QixDQUFiOztBQUNBLGNBQUlJLE1BQU0sSUFBSUEsTUFBTSxDQUFDLENBQUQsQ0FBTixLQUFjLE9BQTVCLEVBQXFDO0FBQ3BDVixZQUFBQSxHQUFHLENBQUNVLE1BQU0sQ0FBQyxDQUFELENBQVAsQ0FBSCxHQUFpQkUsT0FBTyxDQUFDYixJQUFJLEdBQUcsR0FBUCxHQUFhTyxTQUFkLENBQXhCO0FBQ0E7QUFDRDtBQUNELE9BUkQ7QUFTQTs7QUFDRCxXQUFPTixHQUFQO0FBQ0E7O0FBM0JlOztlQThCRnFELE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgZnMgZnJvbSAnZnMnXHJcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnXHJcblxyXG50eXBlIGNvbnRleHRNYXAgPSB7XHJcblx0W2tleTogc3RyaW5nXTogYW55XHJcbn1cclxuXHJcbmNvbnN0IGNvbnRleHQ6IGFueSA9IHtcclxuXHRhcGk6IHt9LFxyXG5cdHNlcnZpY2U6IHt9LFxyXG5cdGRhbzoge31cclxufVxyXG5cclxuLy8g5Yqo5oCB5Yqg6L295paH5Lu2XHJcbmZ1bmN0aW9uIGR5bmFtaWNSZXF1cmllKHBhdGg6IHN0cmluZykge1xyXG5cdGxldCBtYXA6IGNvbnRleHRNYXAgPSB7fVxyXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGgpKSB7XHJcblx0XHRsZXQgY2hpbGRzID0gZnMucmVhZGRpclN5bmMocGF0aClcclxuXHRcdGNoaWxkcy5mb3JFYWNoKGNoaWxkTmFtZSA9PiB7XHJcblx0XHRcdGxldCBpbmZvID0gZnMuc3RhdFN5bmMocGF0aCArIFwiL1wiICsgY2hpbGROYW1lKVxyXG5cdFx0XHRpZiAoIWluZm8uaXNEaXJlY3RvcnkoKSkge1xyXG5cdFx0XHRcdGxldCByZXN1bHQgPSAvKFxcUyspXFwuKGpzfHRzKSQvLmV4ZWMoY2hpbGROYW1lKVxyXG5cdFx0XHRcdGlmIChyZXN1bHQgJiYgcmVzdWx0WzFdICE9PSAnaW5kZXgnKSB7XHJcblx0XHRcdFx0XHRtYXBbcmVzdWx0WzFdXSA9IHJlcXVpcmUocGF0aCArICcvJyArIGNoaWxkTmFtZSlcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHRcdH0pXHJcblx0fVxyXG5cdHJldHVybiBtYXBcclxufVxyXG5cclxuZnVuY3Rpb24gaW5qZWN0KGNvbnN0cnVjdG9yOiBhbnksIGluc3RhbmNlOiBhbnkpIHtcclxuXHRpZiAoY29uc3RydWN0b3IuaW5qZWN0KSB7XHJcblx0XHRjb25zdHJ1Y3Rvci5pbmplY3QuZm9yRWFjaCgoaW5qZWN0TmFtZTogYW55KSA9PiB7XHJcblx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpbnN0YW5jZSwgaW5qZWN0TmFtZSwge1xyXG5cdFx0XHRcdGdldCgpIHtcclxuXHRcdFx0XHRcdHJldHVybiBjb250ZXh0LmRhb1tpbmplY3ROYW1lXSB8fCBjb250ZXh0LnNlcnZpY2VbaW5qZWN0TmFtZV0gfHwgY29udGV4dC5hcGlbaW5qZWN0TmFtZV1cclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pXHJcblx0XHR9KVxyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaXN0ZXJEYW8oYXBwOiBBcHBsaWNhdGlvbikge1xyXG5cdGxldCBkYW9NYXA6IGFueSA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2RhbycpKVxyXG5cdE9iamVjdC5rZXlzKGRhb01hcCkuZm9yRWFjaChkYW9OYW1lID0+IHtcclxuXHRcdGNvbnRleHQuZGFvW2Rhb05hbWVdID0gbmV3IGRhb01hcFtkYW9OYW1lXSgpXHJcblx0fSlcclxufVxyXG5cclxuZnVuY3Rpb24gcmVnaXN0ZXJTZXJ2aWNlKGFwcDogQXBwbGljYXRpb24pIHtcclxuXHRsZXQgc2VydmljZU1hcCA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL3NlcnZpY2UnKSlcclxuXHRPYmplY3Qua2V5cyhzZXJ2aWNlTWFwKS5mb3JFYWNoKHNlcnZpY2VOYW1lID0+IHtcclxuXHRcdGxldCBTZXJ2aWNlQ29uc3RydWN0b3I6IGFueSA9IHNlcnZpY2VNYXBbc2VydmljZU5hbWVdXHJcblx0XHRjb250ZXh0LnNlcnZpY2Vbc2VydmljZU5hbWVdID0gbmV3IFNlcnZpY2VDb25zdHJ1Y3RvcigpXHJcblx0XHRpbmplY3QoU2VydmljZUNvbnN0cnVjdG9yLCBjb250ZXh0LnNlcnZpY2Vbc2VydmljZU5hbWVdKVxyXG5cdH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlZ2lzdGVyQXBpUm91dGVyKGFwcDogYW55KSB7XHJcblx0bGV0IGFwaU1hcCA9IGR5bmFtaWNSZXF1cmllKHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuL2FwaScpKVxyXG5cdE9iamVjdC5rZXlzKGFwaU1hcCkubWFwKGFwaU5hbWUgPT4ge1xyXG5cdFx0bGV0IEFwaUNvbnN0cnVjdG9yOiBhbnkgPSBhcGlNYXBbYXBpTmFtZV0uZGVmYXVsdFxyXG5cdFx0bGV0IGFwaUluc3RhbmNlID0gbmV3IEFwaUNvbnN0cnVjdG9yKClcclxuXHJcblx0XHRpbmplY3QoQXBpQ29uc3RydWN0b3IsIGFwaUluc3RhbmNlKVxyXG5cclxuXHRcdE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKEFwaUNvbnN0cnVjdG9yLnByb3RvdHlwZSkubWFwKGtleSA9PiB7XHJcblx0XHRcdGlmIChhcGlJbnN0YW5jZVtrZXldLnJlcXVlc3RNZXRob2QpIHtcclxuXHRcdFx0XHRsZXQgeyByZXF1ZXN0VXJsLCByZXF1ZXN0TWV0aG9kLCBtaWRkbGVXYXJlIH0gPSBhcGlJbnN0YW5jZVtrZXldXHJcblx0XHRcdFx0bWlkZGxlV2FyZSA9IG1pZGRsZVdhcmUgfHwgW11cclxuXHRcdFx0XHRtaWRkbGVXYXJlLnB1c2goYXBpSW5zdGFuY2Vba2V5XSlcclxuXHRcdFx0XHRsZXQgbWlkZGxlV2FyZXM6IGFueSA9IFtdXHJcblx0XHRcdFx0bWlkZGxlV2FyZS5mb3JFYWNoKChmbjogRnVuY3Rpb24pID0+IHtcclxuXHRcdFx0XHRcdG1pZGRsZVdhcmVzLnB1c2goKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogRnVuY3Rpb24pID0+IHtcclxuXHRcdFx0XHRcdFx0Zm4uY2FsbChhcGlJbnN0YW5jZSwgcmVxLCByZXMsIG5leHQpXHJcblx0XHRcdFx0XHR9KVxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0YXBwW3JlcXVlc3RNZXRob2RdKHJlcXVlc3RVcmwsIC4uLm1pZGRsZVdhcmVzKVxyXG5cdFx0XHR9XHJcblx0XHR9KVxyXG5cdH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlZ2lzdGVyU3RhdGljRmlsZVJvdXRlcihhcHA6IGFueSkge1xyXG5cdGFwcC51c2UoYXBwLmdldCgnZXhwcmVzcycpLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vc3RhdGljJykpKVxyXG5cdGFwcC51c2UoJy9jYXJkJywgYXBwLmdldCgnZXhwcmVzcycpLnN0YXRpYyhwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vY2FyZHMnKSkpXHJcbn1cclxuXHJcbnR5cGUgQ29udGV4dCA9IHtcclxuXHRpbml0KGFwcDogYW55KTogdm9pZFxyXG59XHJcblxyXG5sZXQgQ29udGV4dDogQ29udGV4dCA9IHtcclxuXHRpbml0OiAoYXBwOiBhbnkpID0+IHtcclxuXHRcdGFwcC5jb250ZXh0ID0gY29udGV4dFxyXG5cdFx0cmVnaXN0ZXJTZXJ2aWNlKGFwcClcclxuXHRcdHJlZ2lzdGVyQXBpUm91dGVyKGFwcClcclxuXHRcdHJlZ2lzdGVyRGFvKGFwcClcclxuXHRcdHJlZ2lzdGVyU3RhdGljRmlsZVJvdXRlcihhcHApXHJcblx0fVxyXG59XHJcblxyXG5jbGFzcyBBcHBDb250ZXh0IHtcclxuXHRwcml2YXRlIGNvbnRyb2xsZXI6IGNvbnRleHRNYXBcclxuXHRwcml2YXRlIHNlcnZpY2U6IGNvbnRleHRNYXBcclxuXHRwcml2YXRlIGRhbzogY29udGV4dE1hcFxyXG5cdHB1YmxpYyBzdGF0aWMgaW5pdDogYW55XHJcblxyXG5cdGNvbnN0cnVjdG9yKCkge1xyXG5cdFx0dGhpcy5jb250cm9sbGVyID0ge31cclxuXHRcdHRoaXMuc2VydmljZSA9IHt9XHJcblx0XHR0aGlzLmRhbyA9IHt9XHJcblx0fVxyXG5cclxuXHRkeW5hbWljUmVxdXJpZShwYXRoOiBzdHJpbmcpIHtcclxuXHRcdGxldCBtYXA6IGNvbnRleHRNYXAgPSB7fVxyXG5cdFx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aCkpIHtcclxuXHRcdFx0bGV0IGNoaWxkcyA9IGZzLnJlYWRkaXJTeW5jKHBhdGgpXHJcblx0XHRcdGNoaWxkcy5mb3JFYWNoKChjaGlsZE5hbWU6IHN0cmluZykgPT4ge1xyXG5cdFx0XHRcdGxldCBpbmZvOiBmcy5TdGF0cyA9IGZzLnN0YXRTeW5jKHBhdGggKyBcIi9cIiArIGNoaWxkTmFtZSlcclxuXHRcdFx0XHRpZiAoIWluZm8uaXNEaXJlY3RvcnkoKSkge1xyXG5cdFx0XHRcdFx0bGV0IHJlc3VsdCA9IC8oXFxTKylcXC4oanN8dHMpJC8uZXhlYyhjaGlsZE5hbWUpXHJcblx0XHRcdFx0XHRpZiAocmVzdWx0ICYmIHJlc3VsdFsxXSAhPT0gJ2luZGV4Jykge1xyXG5cdFx0XHRcdFx0XHRtYXBbcmVzdWx0WzFdXSA9IHJlcXVpcmUocGF0aCArICcvJyArIGNoaWxkTmFtZSlcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblx0XHRcdH0pXHJcblx0XHR9XHJcblx0XHRyZXR1cm4gbWFwXHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBDb250ZXh0Il19